# Ghi chép các bước thao tác với một số case card raid H730 mini

Card raid H730mini thường dùng trong dòng Dell R630, Dell R730 hỗ trợ các mode raid 0, 1, 5, 6, 10

![](../images/case-raid-h730mini/Screenshot_121.png)


Cài megacli để hỗ trợ lệnh check raid

```
yum install -y pciutils 

yum install sg3_utils wget git -y
git clone https://github.com/nhanhoadocs/ghichep-megacli.git
rpm -ivh ghichep-megacli/MegaCli8.07.14/Linux/MegaCli-8.07.14-1.noarch.rpm
echo "alias megacli='/opt/MegaRAID/MegaCli/MegaCli64'" >> /root/.bashrc
source /root/.bashrc
```


## 1. Trường hợp hỏng 1 ổ lắp ổ mới vào raid1

- Ở trạng thái RAID1 chạy ổ định

![](../images/case-raid-h730mini/Screenshot_124.png)

- Khi 1 ổ bị hỏng sẽ báo `DEGRADED`

![](../images/case-raid-h730mini/Screenshot_125.png)

![](../images/case-raid-h730mini/Screenshot_126.png)


- Chuẩn bị 1 ổ mới tinh, clear raid, cùng chủng loại, formart.

![](../images/case-raid-h730mini/Screenshot_127.png)

Card hỗ trợ auto rebuild nhưng phải check chắc chắn bằng lệnh

```
megacli -AdpAllinfo  -aALL  | grep -i rebuild
```

![](../images/case-raid-h730mini/Screenshot_122.png)

Cắm thay thế ổ hỏng.

![](../images/case-raid-h730mini/Screenshot_128.png)


Chạy lệnh để xem ổ đang rebuild

```
megacli -PDList -aALL | grep "Firmware state"
```

![](../images/case-raid-h730mini/Screenshot_129.png)

Hoặc xem all

```
megacli -PDList -aALL
```

Xem % đang rebuild

```
megacli -PDRbld -ShowProg -PhysDrv [32:1] -aALL
```

Trong đó 32:1 là các tham số sau: check băng lệnh

```
megacli -PDList -aall
```

```
Enclosure Device ID: 32
Slot Number: 1
```

![](../images/case-raid-h730mini/Screenshot_132.png)


Tùy vào lượng dữ liệu nhiều hay ít nên thời gian rebuild lâu hay nhanh trung bình 2GB mất 10 phút. Sau khi rebuild xong

![](../images/case-raid-h730mini/Screenshot_121.png)


Lưu ý: Trường hợp đang rebuild đồng bộ dữ liệu mà server mất điện, có điện dữ liệu vẫn tiếp tục đồng bộ sang ổ mới cắm.

![](../images/case-raid-h730mini/Screenshot_136.png)

![](../images/case-raid-h730mini/Screenshot_137.png)

## 2. Trường hợp rút ổ khỏi bay

Khi raid đang chạy ổn định nếu rút 1 ổ khỏi raid ra thì tùy từng mode raid sẽ có thông báo khác nhau. Ví dụ như raid 1 sẽ có thông báo degrate.

Sau khi cắm lại chính ổ đó sẽ không join vào raid mà báo trạng thái Foreign

![](../images/case-raid-h730mini/Screenshot_122.png)

Phải reboot lại và import lại Foreign

Sẽ xuất hiện màn hình hiển thị "C" để clean, "F" để Foreign

Sau khi ấn F xong thì quá trình đông bộ dự liệu mới sang ổ diễn ra

![](../images/case-raid-h730mini/Screenshot_123.png)

## 3. Trường hợp thay thế card raid

Chuẩn bị 1 card raid cùng loại

- Nếu card raid đó chưa tạo raid thì cắm vào cái nhận luôn không phải thao tác gì thêm.

- Nếu card đó đã dùng để tạo raid rồi thì sau khi thay card sẽ phải import lại:

![](../images/case-raid-h730mini/Screenshot_134.png)

+ Có thể phải import trong card raid

+ Hoặc có TH cắm card mới xong rever tự detect tới bước như ảnh dưới reboot lại là ăn.

![](../images/case-raid-h730mini/Screenshot_135.png)

## 4. Trường hợp 2 ổ OS hỏng có ổ OS cài sẵn mang lên thay OS



### Tham khảo

https://wikitech.wikimedia.org/wiki/MegaCli

