## Ghi chép vận hành, xử lý sự cố galera mariadb


### Mục lục

[1. Chuẩn bị môi trường](#moitruong)<br>
[2. Xử lý sự cố](#suco)<br>

<a name="moitruong"></a>
## 1. Chuẩn bị môi trường

Sử dụng tiếp kết quả và mô hình của bài cài đặt về pacemaker - haproxy - galera mariadb để test các case vận hành với mariadb.

Triển khai pacemaker - haproxy - galera mariadb <a href="https://github.com/domanhduy/ghichep/blob/master/DuyDM/Cluster-HA/Cluster/docs/3.Cai-dat-haproxy-pamaker-cluster-galare-3-node-wp.md" target="_blank">tại đây</a>!

**Định nghĩa về sự cố**

Trường hợp xảy ra sự cố có 2 kiểu:

`An toàn`: Tức dịch vụ tắt bình thường `systemctl stop mariadb`

`Không an toàn`: Khi tiến trình bị crash, os xảy ra vấn đề, mất điện ....

<a name="suco"></a>
## 2. Xử lý sự cố

### 2.1. Trường hợp 1: 1 node xảy ra vấn đề

Mô hình triển khai có 3 node về mặt lý thuyết 1 node down thì cụm vẫn hoạt động bình thường.

**Down 1 node an toàn**

- Sự cố

```
systemctl stop mariadb
```

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_755.png)

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_756.png)

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_757.png)

- Xử lý

Start lại tiến trình database, dịch vụ hoạt động bình thường

```
systemctl start mariadb
```

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_758.png)

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_759.png)

**Down 1 không an toàn init 0**

- Sự cố

```
init 0
```

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_760.png)

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_761.png)

- Xử lý

Khởi động lại OS và tiến trình database, dịch vụ hoạt động bình thường

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_762.png)


**Down 1 không an toàn kiểu mất điện tắt nóng server**

- Sự cố

Mất điện server

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_764.png)

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_765.png)

- Xử lý

Khởi động lại OS và tiến trình database, dịch vụ hoạt động bình thường

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_766.png)

### 2.1. Trường hợp 2: 2 node xảy ra vấn đề

**Down 2 node an toàn lần lượt**

- Sự cố

Stop node 1 -> node 2

```
systemctl stop mariadb
```

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_767.png)

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_768.png)


- Xử lý

Start tiến trình database, dịch vụ hoạt động bình thường


```
systemctl start mariadb
```

Stop node 2 -> node 1 (tắt sau thì bật trước).

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_770.png)

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_769.png)


**Down 1 không an toàn init 0**

- Sự cố

```
init 0
```

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_771.png)

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_772.png)

- Xử lý

Khởi động lại OS ở các node và tiến trình database, dịch vụ hoạt động bình thường

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_773.png)


**Down 2 không an toàn kiểu mất điện tắt nóng server**

- Sự cố

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_774.png)

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_775.png)

Database bị phân mảnh -> 

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_776.png)

Xác định trạng thái `split brain` cluster đang có vấn đề.

Login mysql

```
mysql -u root -p
```

```
SHOW STATUS LIKE 'wsrep%';
```

Xem các tham số `wsrep_cluster_status          | non-Primary `, `wsrep_local_state_comment     | Initialized`, ` wsrep_ready                   | OFF` dấu hiệu của cluster đang có vấn đề.

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_779.png)

Xem log mariadb sẽ báo `timed out`, `connection to peer`

```
2020-11-12 11:26:55 139828347782912 [Note] WSREP: New COMPONENT: primary = no, bootstrap = no, my_idx = 0, memb_num = 1
2020-11-12 11:26:55 139828347782912 [Note] WSREP: Flow-control interval: [16, 16]
2020-11-12 11:26:55 139828347782912 [Note] WSREP: Received NON-PRIMARY.
2020-11-12 11:26:55 139828347782912 [Note] WSREP: Shifting SYNCED -> OPEN (TO: 510)
2020-11-12 11:26:55 139828347782912 [Note] WSREP: New COMPONENT: primary = no, bootstrap = no, my_idx = 0, memb_num = 1
2020-11-12 11:26:55 139828347782912 [Note] WSREP: Flow-control interval: [16, 16]
2020-11-12 11:26:55 139828347782912 [Note] WSREP: Received NON-PRIMARY.
2020-11-12 11:26:55 139828569024256 [Note] WSREP: New cluster view: global state: bc40f3b7-22c3-11eb-a2d6-f21ad702ac27:510, view# -1: non-Primary, number of nodes: 1, my index: 0, protocol version 3
2020-11-12 11:26:55 139828569024256 [Note] WSREP: wsrep_notify_cmd is not defined, skipping notification.
2020-11-12 11:26:55 139828569024256 [Note] WSREP: New cluster view: global state: bc40f3b7-22c3-11eb-a2d6-f21ad702ac27:510, view# -1: non-Primary, number of nodes: 1, my index: 0, protocol version 3
2020-11-12 11:26:55 139828569024256 [Note] WSREP: wsrep_notify_cmd is not defined, skipping notification.
2020-11-12 11:26:56 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') connection to peer 00000000 with addr tcp://10.10.30.34:4567 timed out, no messages seen in PT3S, socket stats: rtt: 0 rttvar: 250000 rto: 2000000 lost: 1 last_data_recv: 4294838773 cwnd: 1 last_queued_since: 171477632045 last_delivered_since: 171477632045 send_queue_length: 0 send_queue_bytes: 0
2020-11-12 11:26:59 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') connection to peer 00000000 with addr tcp://10.10.30.38:4567 timed out, no messages seen in PT3S, socket stats: rtt: 0 rttvar: 250000 rto: 2000000 lost: 1 last_data_recv: 4294841774 cwnd: 1 last_queued_since: 174478275622 last_delivered_since: 174478275622 send_queue_length: 0 send_queue_bytes: 0
2020-11-12 11:27:00 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') connection to peer 00000000 with addr tcp://10.10.30.34:4567 timed out, no messages seen in PT3S, socket stats: rtt: 0 rttvar: 250000 rto: 2000000 lost: 1 last_data_recv: 4294842774 cwnd: 1 last_queued_since: 175478502338 last_delivered_since: 175478502338 send_queue_length: 0 send_queue_bytes: 0
2020-11-12 11:27:03 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') connection to peer 00000000 with addr tcp://10.10.30.38:4567 timed out, no messages seen in PT3S, socket stats: rtt: 0 rttvar: 250000 rto: 2000000 lost: 1 last_data_recv: 4294845775 cwnd: 1 last_queued_since: 178479359365 last_delivered_since: 178479359365 send_queue_length: 0 send_queue_bytes: 0
2020-11-12 11:27:04 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') connection to peer 00000000 with addr tcp://10.10.30.34:4567 timed out, no messages seen in PT3S, socket stats: rtt: 0 rttvar: 250000 rto: 2000000 lost: 1 last_data_recv: 4294846775 cwnd: 1 last_queued_since: 179479624152 last_delivered_since: 179479624152 send_queue_length: 0 send_queue_bytes: 0
2020-11-12 11:27:08 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') connection to peer 00000000 with addr tcp://10.10.30.38:4567 timed out, no messages seen in PT3S, socket stats: rtt: 0 rttvar: 250000 rto: 4000000 lost: 1 last_data_recv: 4294850276 cwnd: 1 last_queued_since: 182980411567 last_delivered_since: 182980411567 send_queue_length: 0 send_queue_bytes: 0
2020-11-12 11:27:09 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') connection to peer 00000000 with addr tcp://10.10.30.34:4567 timed out, no messages seen in PT3S, socket stats: rtt: 0 rttvar: 250000 rto: 2000000 lost: 1 last_data_recv: 4294851276 cwnd: 1 last_queued_since: 183980716187 last_delivered_since: 183980716187 send_queue_length: 0 send_queue_bytes: 0
2020-11-12 11:27:12 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') connection to peer 00000000 with addr tcp://10.10.30.38:4567 timed out, no messages seen in PT3S, socket stats: rtt: 0 rttvar: 250000 rto: 2000000 lost: 1 last_data_recv: 4294854277 cwnd: 1 last_queued_since: 186981650821 last_delivered_since: 186981650821 send_queue_length: 0 send_queue_bytes: 0
2020-11-12 11:27:13 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') connection to peer 00000000 with addr tcp://10.10.30.34:4567 timed out, no messages seen in PT3S, socket stats: rtt: 0 rttvar: 250000 rto: 2000000 lost: 1 last_data_recv: 4294855277 cwnd: 1 last_queued_since: 187981889615 last_delivered_since: 187981889615 send_queue_length: 0 send_queue_bytes: 0
2020-11-12 11:27:17 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') connection to peer 00000000 with addr tcp://10.10.30.34:4567 timed out, no messages seen in PT3S, socket stats: rtt: 0 rttvar: 250000 rto: 2000000 lost: 1 last_data_recv: 4294859278 cwnd: 1 last_queued_since: 191982931438 last_delivered_since: 191982931438 send_queue_length: 0 send_queue_bytes: 0
2020-11-12 11:28:29 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') reconnecting to d58d8245 (tcp://10.10.30.38:4567), attempt 30
2020-11-12 11:28:31 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') reconnecting to 00ef0daa (tcp://10.10.30.34:4567), attempt 30
2020-11-12 11:29:59 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') reconnecting to d58d8245 (tcp://10.10.30.38:4567), attempt 60
2020-11-12 11:30:01 139828356175616 [Note] WSREP: (ef3bfb74, 'tcp://0.0.0.0:4567') reconnecting to 00ef0daa (tcp://10.10.30.34:4567), attempt 60
```

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_780.png)

```
curl 10.10.30.37
```
Báo `Error establishing a database connection`

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_777.png)


**Nguyên nhân của sự cố**: Database bị phân mảnh sự trên các dấu hiệu trên -> Dẫn tới web không connect được tới database -> Haproxy check sẽ báo lỗi 503 nên dẫn tới `web-backend` httpd cũng báo đỏ.

![](../images/van-hanh-su-co-galera-mariadb/Screenshot_778.png)


- Xử lý

Khôi phục lại database -> `web-backend` httpd báo xanh.

Bước 1: Chắc chắn tắt hẳn 2 node trong trạng thái lỗi.
Bước 2: Tại node không lỗi thực hiện























































